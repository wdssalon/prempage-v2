#!/usr/bin/env bash
set -euo pipefail

echo "[pre-push] Checking OpenAPI schema parity"
if ! python3 scripts/check_openapi_sync.py; then
  echo "[pre-push] OpenAPI schema / TypeScript types out of sync" >&2
  exit 1
fi

if ! command -v uv >/dev/null 2>&1; then
  echo "[pre-push] uv is required to run backend tests. Install uv (Python >= 3.11) first." >&2
  exit 1
fi

echo "[pre-push] Running FastAPI backend tests"
( cd backend && uv run --active pytest )
echo "[pre-push] FastAPI backend tests passed"

if ! command -v pnpm >/dev/null 2>&1; then
  echo "[pre-push] pnpm is required to run Studio tests and lint static sites. Install pnpm (Node >= 20) first." >&2
  exit 1
fi

echo "[pre-push] Ensuring Studio dependencies are installed"
CI=1 pnpm --dir client install --frozen-lockfile >/dev/null

echo "[pre-push] Running Studio UI tests"
CI=1 pnpm --dir client run test
echo "[pre-push] Studio UI tests passed"

SLUGS=("progressivewaytherapy-horizon")

for slug in "${SLUGS[@]}"; do
  site_dir="public-sites/sites/${slug}"
  if [[ ! -d "${site_dir}" ]]; then
    echo "[pre-push] Skipping unknown site directory ${site_dir}" >&2
    continue
  fi

  echo "[pre-push] Installing dependencies for ${slug}"
  CI=1 pnpm --dir "${site_dir}" install --frozen-lockfile --prefer-offline >/dev/null

  echo "[pre-push] Linting ${slug}"
  pnpm --dir "${site_dir}" run lint
done

echo "[pre-push] Static site lint checks passed"
